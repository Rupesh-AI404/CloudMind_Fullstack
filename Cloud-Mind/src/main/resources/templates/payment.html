<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Payment - Cloud Mind</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<section class="py-5" style="margin-top: 80px;">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <div class="text-center mb-4">
                        <h4 class="fw-bold mb-2">Complete Your Payment</h4>
                        <p class="text-muted">Choose your preferred payment method</p>
                    </div>
                    <form th:action="@{/payment}" method="post" id="paymentForm">
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">Select Payment Method</h6>
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3"><i class="bi bi-globe me-2"></i>International Payment</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="stripe" value="stripe" autocomplete="off">
                                            <label class="btn btn-outline-primary w-100 p-3" for="stripe">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center"><i class="bi bi-credit-card me-2"></i><span>Credit/Debit Card</span></div>
                                                    <div class="d-flex gap-1"><img src="https://img.icons8.com/color/24/visa.png" alt="Visa"><img src="https://img.icons8.com/color/24/mastercard.png" alt="Mastercard"></div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="paypal" value="paypal" autocomplete="off">
                                            <label class="btn btn-outline-primary w-100 p-3" for="paypal">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center"><i class="bi bi-paypal me-2"></i><span>PayPal</span></div>
                                                    <img src="https://img.icons8.com/color/24/paypal.png" alt="PayPal">
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6 class="text-muted mb-3"><i class="bi bi-flag me-2"></i>Nepali Payment Methods</h6>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="esewa" value="esewa" autocomplete="off">
                                            <label class="btn btn-outline-success w-100 p-3" for="esewa">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center"><i class="bi bi-wallet2 me-2"></i><span>eSewa</span></div>
                                                    <img src="https://esewa.com.np/common/images/esewa-icon-large.png" alt="eSewa" style="height: 24px; width: auto;" onerror="this.style.display='none'">
                                                </div>
                                            </label>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="radio" class="btn-check" name="paymentMethod" id="khalti" value="khalti" autocomplete="off">
                                            <label class="btn btn-outline-success w-100 p-3" for="khalti">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <div class="d-flex align-items-center"><i class="bi bi-phone me-2"></i><span>Khalti</span></div>
                                                    <span style="background: #5D2E8E; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">KHALTI</span>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="paymentDetails" style="display: none;">
                            <div id="cardPayment" style="display: none;">
                                <h6 class="fw-bold mb-3">Card Information</h6>
                                <div class="row g-3">
                                    <div class="col-12"><label for="cardNumber" class="form-label">Card Number</label><input type="text" class="form-control" id="cardNumber" name="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required></div>
                                    <div class="col-md-6"><label for="expiryDate" class="form-label">Expiry Date</label><input type="text" class="form-control" id="expiryDate" name="expiryDate"  placeholder="MM/YY" maxlength="5" required></div>
                                    <div class="col-md-6"><label for="cvv" class="form-label">CVV</label><input type="text" class="form-control" id="cvv" name="cvv"  placeholder="123" maxlength="4" required></div>
                                    <div class="col-12"><label for="cardName" class="form-label">Cardholder Name</label><input type="text" class="form-control" id="cardName" name="cardName"  placeholder="John Doe" required></div>
                                </div>
                            </div>
                            <div id="walletPayment" style="display: none;">
                                <h6 class="fw-bold mb-3">Digital Wallet Information</h6>
                                <div class="row g-3">
                                    <div class="col-12"><label for="walletPhone" class="form-label">Mobile Number</label><input type="tel" class="form-control" id="walletPhone" name="walletPhone" placeholder="98XXXXXXXX" required></div>
                                    <div class="col-12"><label for="walletPin" class="form-label">PIN/MPIN</label><input type="password" class="form-control" id="walletPin" name="walletPin" placeholder="Enter your PIN" required autocomplete="new-password"></div>
                                </div>
                            </div>
                        </div>
                        <div class="border rounded p-3 mb-4 bg-light">
                            <h6 class="fw-bold mb-3">Order Summary</h6>
                            <div class="d-flex justify-content-between mb-2">
                                <span th:text="${selectedPlan} ?: 'Professional Plan'"></span>
                                <span th:with="price=${selectedPlan == 'starter' ? 999 : (selectedPlan == 'professional' ? 2499 : 4999)}">
         $<span th:text="${price}"></span>.00
    </span>
                            </div>
                            <div class="d-flex justify-content-between mb-2" th:if="${selectedBilling == 'annually'}" id="discountRow" style="display: none;">
                                <span>Annual Discount (20%)</span>
                                <span class="text-success" th:with="discount=${selectedPlan == 'starter' ? 199.80 : (selectedPlan == 'professional' ? 499.80 : 999.80)}">
        -$<span th:text="${discount}"></span>
    </span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span th:text="'Total (' + (${selectedBilling} ?: 'Monthly') + ')'"></span>
                                <span th:with="total=${selectedBilling == 'annually' ? (selectedPlan == 'starter' ? 799.20 : (selectedPlan == 'professional' ? 1999.20 : 3999.20)) : (selectedPlan == 'starter' ? 999.00 : (selectedPlan == 'professional' ? 2499.00 : 4999.00))}">
        $<span th:text="${total}"></span>.00
    </span>
                            </div>
                        </div>
                        <div class="d-flex gap-3">
                            <a th:href="@{/subscription}" class="btn btn-outline-secondary flex-fill"><i class="bi bi-arrow-left me-2"></i>Back</a>
                            <button type="submit" class="btn btn-gradient flex-fill" id="payNowBtn"><i class="bi bi-lock me-2"></i>Pay Now</button>
                        </div>
                        <div class="text-center mt-4"><small class="text-muted"><i class="bi bi-shield-check me-1"></i>All payments are secured with 256-bit SSL encryption</small></div>
                    </form>

                    <!-- Success Modal -->

                    <!-- Add this modal to your payment-success.html -->
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

                    <!-- Success Modal -->
                    <div class="modal fade" id="paymentSuccessModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content border-0 shadow-lg">
                                <div class="modal-body text-center p-5">
                                    <!-- Success Icon -->
                                    <div class="mb-4">
                                        <div class="success-icon mx-auto">
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                                        </div>
                                    </div>

                                    <!-- Success Message -->
                                    <h3 class="text-success fw-bold mb-3">Payment Successful!</h3>
                                    <p class="lead mb-4">Thank you for your payment!</p>

                                    <!-- Payment Details -->
                                    <div class="bg-light rounded p-3 mb-4">
                                        <div class="row text-start">
                                            <div class="col-6">
                                                <small class="text-muted">Plan:</small><br>
                                                <strong th:text="${selectedPlan}">Professional</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Billing:</small><br>
                                                <strong th:text="${selectedBilling}">Monthly</strong>
                                            </div>
                                        </div>
                                        <hr class="my-2">
                                        <div class="row text-start">
                                            <div class="col-6">
                                                <small class="text-muted">Payment Method:</small><br>
                                                <strong th:text="${paymentMethod}">Stripe</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Email:</small><br>
                                                <strong th:text="${userEmail}">user@example.com</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Redirect Message -->
                                    <div class="alert alert-info d-flex align-items-center">
                                        <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Redirecting to dashboard in <span id="countdown">5</span> seconds...</span>
                                    </div>

                                    <!-- Action Button -->
                                    <button type="button" class="btn btn-primary btn-lg" onclick="goToDashboard()">
                                        <i class="bi bi-house-door-fill me-2"></i>Go to Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Add some custom CSS for the success icon animation -->
                    <style>
                        .success-icon {
                            animation: bounceIn 0.6s ease-out;
                        }

                        @keyframes bounceIn {
                            0% {
                                transform: scale(0.3);
                                opacity: 0;
                            }
                            50% {
                                transform: scale(1.05);
                            }
                            70% {
                                transform: scale(0.9);
                            }
                            100% {
                                transform: scale(1);
                                opacity: 1;
                            }
                        }

                        .modal-content {
                            border-radius: 15px !important;
                        }
                    </style>



                </div>
            </div>
        </div>
    </div>
</section>

<footer class="footer-modern py-5 mt-5">
    <div class="container">
        <div class="row gy-4 gx-5">
            <div class="col-6 col-md-3 col-lg-2"><h6 class="footer-heading">SERVICES</h6><ul class="footer-list"><li><a href="services.html">Content Marketing</a></li><li><a href="services.html">Data Analytics</a></li><li><a href="services.html">Audience Targeting</a></li><li><a href="services.html">Social Media Marketing</a></li><li><a href="services.html">SEO Optimization</a></li><li><a href="services.html">Performance Optimization</a></li></ul></div>
            <div class="col-6 col-md-3 col-lg-2"><h6 class="footer-heading">COMPANY</h6><ul class="footer-list"><li><a href="about.html">About</a></li><li><a href="#">Careers</a></li><li><a href="contact.html">Contact</a></li><li><a href="#">Terms</a></li><li><a href="#">Privacy</a></li></ul></div>
            <div class="col-6 col-md-3 col-lg-2"><h6 class="footer-heading">RESOURCES</h6><ul class="footer-list"><li><a href="#">Blog</a></li><li><a href="#">Documentation</a></li><li><a href="#">Community</a></li><li><a href="#">Events</a></li><li><a href="#">Guides</a></li></ul></div>
            <div class="col-6 col-md-3 col-lg-3"><h6 class="footer-heading">GUIDES</h6><ul class="footer-list"><li><a href="#">Digital Marketing Guide</a></li><li><a href="#">SEO Best Practices</a></li><li><a href="#">Content Strategy</a></li><li><a href="#">Analytics & Reporting</a></li><li><a href="#">Automation Tools</a></li></ul></div>
            <div class="col-12 col-lg-3"><h6 class="footer-heading">FOLLOW US</h6><div class="footer-social d-flex gap-3 mt-2"><a href="#" class="footer-social-icon" aria-label="Facebook"><i class="bi bi-facebook"></i></a><a href="#" class="footer-social-icon" aria-label="Twitter"><i class="bi bi-twitter"></i></a><a href="#" class="footer-social-icon" aria-label="Instagram"><i class="bi bi-instagram"></i></a><a href="#" class="footer-social-icon" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a></div></div>
        </div>
        <hr class="footer-divider my-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="footer-copyright mb-2 mb-md-0">&copy; 2025 Cloud Mind Agency. All rights reserved.</div>
            <div class="footer-legal"><a href="#" class="me-3">Terms of Use</a><a href="#">Privacy Policy</a></div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/script.js"></script>

<!--<script th:if="${success}" th:inline="javascript">-->
<!--    document.addEventListener('DOMContentLoaded', function () {-->
<!--        const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'), {-->
<!--            backdrop: 'static', keyboard: false-->
<!--        });-->
<!--        modal.show();-->

<!--        // auto-redirect to dashboard after 5s-->
<!--        setTimeout(function () {-->
<!--            window.location.href = [[@{/user-dashboard}]];-->
<!--        }, 5000);-->
<!--        });-->
<!--</script>-->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form submission handling
        const paymentForm = document.getElementById('paymentForm');
        const paymentDetails = document.getElementById('paymentDetails');
        const cardPayment = document.getElementById('cardPayment');
        const walletPayment = document.getElementById('walletPayment');

        const cardFields = ['cardNumber','expiryDate','cvv','cardName'].map(id=>document.getElementById(id));
        const walletFields = ['walletPhone','walletPin'].map(id=>document.getElementById(id));

        function setRequired(fields, required) {
            fields.forEach(f => { if (f) f.required = required; });
        }

        // Payment method selection
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                paymentDetails.style.display = 'block';
                const isCard = (this.value === 'stripe' || this.value === 'paypal');

                cardPayment.style.display = isCard ? 'block' : 'none';
                walletPayment.style.display = isCard ? 'none' : 'block';

                setRequired(cardFields, isCard);
                setRequired(walletFields, !isCard);
            });
        });

        // Form submission handling
        if (paymentForm) {
            paymentForm.addEventListener('submit', function(e) {
                if (!document.querySelector('input[name="paymentMethod"]:checked')) {
                    e.preventDefault();
                    alert('Please select a payment method.');
                    return;
                }

                // Show processing state
                const submitBtn = document.getElementById('payNowBtn');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
                    submitBtn.disabled = true;
                }
            });
        }

        // Card number formatting
        const cardNumberInput = document.getElementById('cardNumber');
        if (cardNumberInput) {
            cardNumberInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                if (formattedValue.length <= 19) {
                    e.target.value = formattedValue;
                }
            });
        }

        // Expiry date formatting
        const expiryInput = document.getElementById('expiryDate');
        if (expiryInput) {
            expiryInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            });
        }
    });

    // Success modal script - only runs when paymentSuccess flag is set
    function goToDashboard() {
        window.location.href = '/user-dashboard';
    }

    let countdownInterval;

    function startCountdown() {
        let countdown = 5;
        const countdownElement = document.getElementById('countdown');

        countdownInterval = setInterval(() => {
            countdown--;
            if (countdownElement) {
                countdownElement.textContent = countdown;
            }

            if (countdown <= 0) {
                clearInterval(countdownInterval);
                goToDashboard();
            }
        }, 1000);
    }
</script>

<!-- Success modal trigger script - only runs when success flag is set -->
<script th:if="${paymentSuccess}">
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Payment successful - showing modal');

        // Show the success modal
        const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'), {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();

        // Start countdown
        startCountdown();
    });
</script>

<!-- Success modal script - only runs when success flag is set -->
<script th:if="${success}">
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Payment successful - showing modal');

        // Show the success modal
        const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'), {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();

        // Auto-redirect after 3 seconds
        setTimeout(function() {
            console.log('Redirecting to dashboard');
            window.location.href = '/user-dashboard';
        }, 2000);
    });
</script>


<script th:src="@{/js/auth.js}"></script>
<script th:src="@{/js/script.js}"></script>

</body>
</html>