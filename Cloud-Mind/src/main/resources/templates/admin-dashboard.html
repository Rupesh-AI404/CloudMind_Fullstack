<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Cloud Mind</title>
    <meta name="description" content="Admin dashboard for managing digital marketing campaigns and analytics.">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
<!-- Navigation -->

<div th:replace="~{fragments/navbar :: navbar}"></div>

<!-- Only show subscription options for non-admin users -->
<div th:if="${session.userRole != 'ADMIN'}" class="subscription-section">
    <!-- Your subscription UI here -->
    <button class="btn btn-primary" onclick="subscribe()">Subscribe</button>
</div>

<!-- Show message for admin -->
<div th:if="${session.userRole == 'ADMIN'}" class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    Admin users don't need subscriptions to access all features.
</div>


<!-- Dashboard Content -->
<main style="padding-top: 140px; min-height: 100vh; background: var(--bg-secondary);">
    <div class="container py-4">
        <!-- Dashboard Header -->
        <div class="row mb-4" style="margin-top: -60px">
            <div class="col-12">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="h3 mb-1 fw-bold">Admin Dashboard</h1>
                            <p class="text-muted mb-0">Welcome back! Here's what's happening with your platform today.</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary">
                                <i class="bi bi-download me-2"></i>Export Report
                            </button>
                            <button class="btn btn-gradient">
                                <i class="bi bi-plus-circle me-2"></i>New Campaign
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Key Metrics -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted small mb-1">Total Users</div>
                            <div class="h4 fw-bold mb-0" th:text="${totalUsers ?: 0}">0</div>
                            <div class="text-muted small">
                                <i class="bi bi-arrow-up text-success me-1"></i>
                                <span>Registered users</span>
                            </div>
                        </div>
                        <div class="text-primary fs-1">
                            <i class="bi bi-people"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted small mb-1">Active Subscriptions</div>
                            <div class="h4 fw-bold mb-0" th:text="${activeCampaigns ?: 0}">0</div>
                            <div class="text-muted small">
                                <i class="bi bi-arrow-up text-success me-1"></i>
                                <span>Paying subscribers</span>
                            </div>
                        </div>
                        <div class="text-success fs-1">
                            <i class="bi bi-rocket"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted small mb-1">Total Revenue</div>
                            <div class="h4 fw-bold mb-0" th:text="'$' + (${totalRevenue ?: 0})">$0</div>
                            <div class="text-muted small">
                                <i class="bi bi-arrow-up text-success me-1"></i>
                                <span>Monthly revenue</span>
                            </div>
                        </div>
                        <div class="text-warning fs-1">
                            <i class="bi bi-currency-dollar"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="glass-card p-4 h-100">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <div class="text-muted small mb-1">Conversion Rate</div>
                            <div class="h4 fw-bold mb-0" th:text="(${conversionRate ?: 0}) + '%'">0%</div>
                            <div class="text-muted small">
                                <i class="bi bi-arrow-up text-success me-1"></i>
                                <span>User to subscriber</span>
                            </div>
                        </div>
                        <div class="text-info fs-1">
                            <i class="bi bi-graph-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- User Purchase & Subscription Tracking -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">
                            <i class="bi bi-people me-2"></i>User Purchase & Subscription Tracking
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshPurchaseData()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="exportPurchaseData()">
                                <i class="bi bi-download me-1"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="packageFilter">
                                <option value="all">All Packages</option>
                                <option value="starter">Starter</option>
                                <option value="pro">Professional</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select form-select-sm" id="statusFilter">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm" placeholder="Search by email..." id="searchFilter">
                        </div>
                    </div>

                    <!-- Debug Information -->
<!--                    <div class="alert alert-info" th:if="${subscribers != null}">-->
<!--                        <strong>Debug:</strong> Found <span th:text="${subscribers.size()}">0</span> subscribers in database-->
<!--                    </div>-->

<!--                    <div class="alert alert-warning" th:if="${subscribers == null}">-->
<!--                        <strong>Warning:</strong> Subscribers data is NULL - check service connection-->
<!--                    </div>-->

                    <!-- Purchase Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="purchaseTable">
                            <thead>
                            <tr>
                                <th class="border-0 small text-muted">User Details</th>
                                <th class="border-0 small text-muted">Contact</th>
                                <th class="border-0 small text-muted">Package</th>
                                <th class="border-0 small text-muted">Subscription</th>
                                <th class="border-0 small text-muted">Payment</th>
                                <th class="border-0 small text-muted">Status</th>
                                <th class="border-0 small text-muted">Revenue</th>
                                <th class="border-0 small text-muted">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="purchaseTableBody">
                            <!-- Dynamic subscriber rows -->
                            <tr th:if="${subscribers != null and !subscribers.isEmpty()}"
                                th:each="subscriber : ${subscribers}">
                                <td class="border-0">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle bg-primary text-white me-3"
                                             style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                            <span th:text="${subscriber.firstName != null ? subscriber.firstName.substring(0,1).toUpperCase() : (subscriber.email != null ? subscriber.email.substring(0,1).toUpperCase() : 'U')}">U</span>
                                        </div>
                                        <div>
                                            <div class="fw-semibold">
                                            <span th:if="${subscriber.firstName != null and subscriber.lastName != null}"
                                                  th:text="${subscriber.firstName + ' ' + subscriber.lastName}">Name</span>
                                                <span th:if="${subscriber.firstName == null or subscriber.lastName == null}"
                                                      th:text="${subscriber.email != null ? subscriber.email.split('@')[0] : 'Unknown User'}">User</span>
                                            </div>
                                            <div class="small text-muted">ID: <span th:text="${subscriber.id}">1</span></div>
                                            <div class="small text-muted" th:if="${subscriber.companyName != null}"
                                                 th:text="${subscriber.companyName}">Company</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="border-0">
                                    <div class="small">
                                        <div th:text="${subscriber.email ?: 'No Email'}">email@example.com</div>
                                        <div class="text-muted" th:if="${subscriber.phoneNumber != null}"
                                             th:text="${subscriber.phoneNumber}">Phone</div>
                                        <div class="text-muted" th:if="${subscriber.city != null and subscriber.country != null}"
                                             th:text="${subscriber.city + ', ' + subscriber.country}">Location</div>
                                    </div>
                                </td>
                                <td class="border-0">
                                <span class="badge"
                                      th:classappend="${subscriber.plan == 'enterprise'} ? 'bg-warning' : (${subscriber.plan == 'pro'} ? 'bg-success' : 'bg-primary')"
                                      th:text="${subscriber.plan ?: 'Unknown'}">Plan</span>
                                    <div class="small text-muted mt-1" th:text="${subscriber.billing ?: 'Monthly'}">Billing</div>
                                </td>
                                <td class="border-0">
                                    <div class="small">
                                        <div th:if="${subscriber.subscriptionDate != null}"
                                             th:text="${#temporals.format(subscriber.subscriptionDate, 'MMM dd, yyyy')}">Date</div>
                                        <div th:if="${subscriber.subscriptionDate == null}" class="text-muted">Recently</div>
                                        <div class="text-muted" th:if="${subscriber.expiryDate != null}"
                                             th:text="'Expires: ' + ${#temporals.format(subscriber.expiryDate, 'MMM dd, yyyy')}">Expiry</div>
                                    </div>
                                </td>
                                <td class="border-0">
                                    <div class="small">
                                        <div th:text="${subscriber.paymentMethod ?: 'Card'}">Payment Method</div>
                                        <div class="text-muted" th:if="${subscriber.cardLast4 != null}"
                                             th:text="'****' + ${subscriber.cardLast4}">Card</div>
                                    </div>
                                </td>
                                <td class="border-0">
                                <span class="badge"
                                      th:classappend="${subscriber.status == 'ACTIVE'} ? 'bg-success' : (${subscriber.status == 'PENDING'} ? 'bg-warning' : 'bg-secondary')"
                                      th:text="${subscriber.status ?: 'PENDING'}">Status</span>
                                </td>
                                <td class="border-0 fw-semibold">
                                    <span th:text="'$' + (${subscriber.plan == 'enterprise'} ? '4999' : (${subscriber.plan == 'pro'} ? '2499' : '999'))">$999</span>
                                    <div class="small text-muted" th:text="'/' + ${subscriber.billing ?: 'month'}">/month</div>
                                </td>
                                <td class="border-0">
                                    <div class="dropdown">
                                        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" th:onclick="'viewSubscriber(' + ${subscriber.id} + ')'">
                                                <i class="bi bi-eye me-2"></i>View Details</a></li>
                                            <li><a class="dropdown-item" href="#" th:onclick="'editSubscriber(' + ${subscriber.id} + ')'">
                                                <i class="bi bi-pencil me-2"></i>Edit</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" th:onclick="'adminCancelSubscription(' + ${subscriber.id} + ')'">
                                                <i class="bi bi-trash me-2"></i>Delete Subscriber</a></li>
                                        </ul>
                                    </div>
                                </td>
                            </tr>

                            <!-- No data message -->
                            <tr th:if="${subscribers == null or subscribers.isEmpty()}">
                                <td colspan="8" class="border-0 text-center py-5">
                                    <div class="text-muted">
                                        <i class="bi bi-inbox display-4 mb-3"></i>
                                        <h5 class="text-muted">No Subscribers Found</h5>
                                        <p class="mb-0">No subscription data available in database.</p>
                                        <div class="mt-3">
                                            <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
                                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
                                            </button>
                                            <a href="/admin/debug" class="btn btn-outline-secondary btn-sm ms-2">
                                                <i class="bi bi-bug me-1"></i>Debug Info
                                            </a>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="small text-muted">
                            Showing <span th:text="${subscribers != null ? subscribers.size() : 0}">0</span> of
                            <span th:text="${subscribers != null ? subscribers.size() : 0}">0</span> subscribers
                        </div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <span class="page-link">Previous</span>
                                </li>
                                <li class="page-item active">
                                    <span class="page-link">1</span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link">Next</span>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>


        <!-- Charts and Analytics -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0">Campaign Performance</h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="timeRange" id="week" checked>
                            <label class="btn btn-outline-primary btn-sm" for="week">7D</label>
                            <input type="radio" class="btn-check" name="timeRange" id="month">
                            <label class="btn btn-outline-primary btn-sm" for="month">30D</label>
                            <input type="radio" class="btn-check" name="timeRange" id="year">
                            <label class="btn btn-outline-primary btn-sm" for="year">1Y</label>
                        </div>
                    </div>
                    <div class="chart-container d-flex align-items-end justify-content-center gap-2" style="height: 200px;">
                        <div class="chart-bar" style="height: 45%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 65%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 35%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 80%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 55%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 90%; background: var(--brand-gradient);"></div>
                        <div class="chart-bar" style="height: 75%; background: var(--brand-gradient);"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4">Top Performing Services</h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Content Marketing</span>
                            <span class="small fw-bold">68%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 68%; background: var(--brand-gradient);"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">SEO Optimization</span>
                            <span class="small fw-bold">52%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 52%; background: var(--brand-gradient);"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Predictive Analytics</span>
                            <span class="small fw-bold">41%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 41%; background: var(--brand-gradient);"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Smart Targeting</span>
                            <span class="small fw-bold">35%</span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: 35%; background: var(--brand-gradient);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Revenue Analytics -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="glass-card p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold mb-0"><i class="bi bi-graph-up me-2"></i>Revenue Analytics</h5>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="revenueRange" id="revenue7d" checked>
                            <label class="btn btn-outline-primary btn-sm" for="revenue7d">7D</label>
                            <input type="radio" class="btn-check" name="revenueRange" id="revenue30d">
                            <label class="btn btn-outline-primary btn-sm" for="revenue30d">30D</label>
                            <input type="radio" class="btn-check" name="revenueRange" id="revenue1y">
                            <label class="btn btn-outline-primary btn-sm" for="revenue1y">1Y</label>
                        </div>
                    </div>
                    <div class="chart-container d-flex align-items-center justify-content-center" style="height: 200px;">
                        <div class="text-center text-muted">
                            <i class="bi bi-bar-chart display-4 mb-3"></i>
                            <h6 class="text-muted">No Revenue Data</h6>
                            <p class="small mb-0">Revenue analytics will appear here once you have active subscriptions.</p>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-4 text-center">
                            <div class="fw-bold text-muted">$0</div>
                            <div class="small text-muted">Total Revenue (7D)</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="fw-bold text-muted">0</div>
                            <div class="small text-muted">Active Subscriptions</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="fw-bold text-muted">$0</div>
                            <div class="small text-muted">Avg Revenue/User</div>
                        </div>
                    </div>
                </div>
            </div>

<!--            Package distribution-->
            <div class="col-lg-4">
                <div class="glass-card p-4">
                    <h5 class="fw-bold mb-4"><i class="bi bi-pie-chart me-2"></i>Package Distribution</h5>

                    <div th:if="${packageDistribution != null}">
                        <!-- Enterprise -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small d-flex align-items-center">
                        <span class="badge bg-warning me-2" style="width: 12px; height: 12px;"></span>
                        Enterprise ($4,999/mo)
                    </span>
                                <span class="small fw-bold" th:text="${packageDistribution.enterprise ?: 0}">0</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-warning" th:style="'width: ' + ((${packageDistribution.enterprise ?: 0} > 0) ? (${packageDistribution.enterprise} * 20) : 0) + '%;'"></div>
                            </div>
                            <div class="small text-muted mt-1" th:text="(${packageDistribution.enterprise ?: 0}) + ' users • $' + ((${packageDistribution.enterprise ?: 0}) * 4999) + '/mo'">0 users • $0/mo</div>
                        </div>

                        <!-- Pro -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small d-flex align-items-center">
                        <span class="badge bg-success me-2" style="width: 12px; height: 12px;"></span>
                        Pro ($2,499/mo)
                    </span>
                                <span class="small fw-bold" th:text="${packageDistribution.pro ?: 0}">0</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-success" th:style="'width: ' + ((${packageDistribution.pro ?: 0} > 0) ? (${packageDistribution.pro} * 20) : 0) + '%;'"></div>
                            </div>
                            <div class="small text-muted mt-1" th:text="(${packageDistribution.pro ?: 0}) + ' users • $' + ((${packageDistribution.pro ?: 0}) * 2499) + '/mo'">0 users • $0/mo</div>
                        </div>

                        <!-- Starter -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="small d-flex align-items-center">
                        <span class="badge bg-primary me-2" style="width: 12px; height: 12px;"></span>
                        Starter ($999/mo)
                    </span>
                                <span class="small fw-bold" th:text="${packageDistribution.starter ?: 0}">0</span>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" th:style="'width: ' + ((${packageDistribution.starter ?: 0} > 0) ? (${packageDistribution.starter} * 20) : 0) + '%;'"></div>
                            </div>
                            <div class="small text-muted mt-1" th:text="(${packageDistribution.starter ?: 0}) + ' users • $' + ((${packageDistribution.starter ?: 0}) * 999) + '/mo'">0 users • $0/mo</div>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Total Monthly Revenue:</span>
                            <span class="fw-bold" th:text="'$' + (${monthlyRevenue ?: 0})">$0</span>
                        </div>
                    </div>

                    <div th:if="${packageDistribution == null}" class="text-center text-muted py-4">
                        <i class="bi bi-pie-chart display-4 mb-3"></i>
                        <h6 class="text-muted">No Package Data</h6>
                        <p class="small mb-4">Package distribution will appear here once users start subscribing.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages & Support -->
        <!-- Contact Messages Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-envelope me-2"></i>Contact Messages
                            <span class="badge bg-danger ms-2" th:if="${unreadCount > 0}" th:text="${unreadCount}">0</span>
                        </h5>
                        <div>
                            <span class="small">Total: <span th:text="${totalMessages}">0</span></span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                <tr>
                                    <th class="border-0 small text-muted">Status</th>
                                    <th class="border-0 small text-muted">Name</th>
                                    <th class="border-0 small text-muted">Email</th>
                                    <th class="border-0 small text-muted">Subject</th>
                                    <th class="border-0 small text-muted">Priority</th>
                                    <th class="border-0 small text-muted">Date</th>
                                    <th class="border-0 small text-muted">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Dynamic contact message rows -->
                                <tr th:if="${contactMessages != null and !contactMessages.isEmpty()}"
                                    th:each="message : ${contactMessages}"
                                    th:class="${message.isRead} ? '' : 'table-warning'">

                                    <td>
                                        <span th:if="${!message.isRead}" class="badge bg-danger">New</span>
                                        <span th:if="${message.isRead}" class="badge bg-success">Read</span>
                                    </td>

                                    <td th:text="${message.name}">Name</td>
                                    <td th:text="${message.email}">email@example.com</td>
                                    <td>
                                    <span th:text="${#strings.length(message.subject) > 30 ? #strings.substring(message.subject, 0, 30) + '...' : message.subject}">
                                        Subject
                                    </span>
                                    </td>

                                    <td>
                                    <span th:class="'badge ' + (${message.priority} == 'high' ? 'bg-danger' : (${message.priority} == 'medium' ? 'bg-warning' : 'bg-secondary'))"
                                          th:text="${#strings.toUpperCase(message.priority)}">PRIORITY</span>
                                    </td>

                                    <td th:text="${#temporals.format(message.createdAt, 'MMM dd, yyyy HH:mm')}">Date</td>

                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1"
                                                data-bs-toggle="modal"
                                                th:data-bs-target="'#messageModal' + ${message.id}">
                                            <i class="bi bi-eye"></i>
                                        </button>

                                        <button th:if="${!message.isRead}"
                                                type="button"
                                                class="btn btn-sm btn-outline-success me-1"
                                                th:onclick="'markAsRead(' + ${message.id} + ')'">
                                            <i class="bi bi-check"></i>
                                        </button>

                                        <button type="button"
                                                class="btn btn-sm btn-outline-danger"
                                                th:onclick="'deleteMessage(' + ${message.id} + ')'">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>

                                <!-- No messages row -->
                                <tr th:if="${contactMessages == null or contactMessages.isEmpty()}">
                                    <td colspan="7" class="text-center py-4 text-muted">
                                        <i class="bi bi-inbox display-4 mb-3"></i>
                                        <h6>No Contact Messages</h6>
                                        <p class="mb-0">No messages have been received yet.</p>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Detail Modals -->
        <div th:each="message : ${contactMessages}">
            <div class="modal fade" th:id="'messageModal' + ${message.id}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" th:text="${message.subject}">Message Subject</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>From:</strong> <span th:text="${message.name}">Name</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Email:</strong> <span th:text="${message.email}">email@example.com</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Priority:</strong>
                                    <span th:class="'badge ' + (${message.priority} == 'high' ? 'bg-danger' : (${message.priority} == 'medium' ? 'bg-warning' : 'bg-secondary'))"
                                          th:text="${#strings.toUpperCase(message.priority)}">PRIORITY</span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Date:</strong> <span th:text="${#temporals.format(message.createdAt, 'MMM dd, yyyy HH:mm')}">Date</span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Message:</strong>
                                <div class="mt-2 p-3 bg-light rounded" th:text="${message.message}">
                                    Message content here...
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button th:if="${!message.isRead}"
                                    type="button"
                                    class="btn btn-success"
                                    th:onclick="'markAsRead(' + ${message.id} + '); $(\'#messageModal' + ${message.id} + '\').modal(\'hide\');'">
                                Mark as Read
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>


<!-- Footer -->
<footer class="footer-modern py-5 mt-5">
    <div class="container">
        <div class="row gy-4 gx-5">
            <div class="col-6 col-md-3 col-lg-2">
                <h6 class="footer-heading">SERVICES</h6>
                <ul class="footer-list">
                    <li><a href="services.html">Content Marketing</a></li>
                    <li><a href="services.html">Data Analytics</a></li>
                    <li><a href="services.html">Audience Targeting</a></li>
                    <li><a href="services.html">Social Media Marketing</a></li>
                    <li><a href="services.html">SEO Optimization</a></li>
                    <li><a href="services.html">Performance Optimization</a></li>
                </ul>
            </div>
            <div class="col-6 col-md-3 col-lg-2">
                <h6 class="footer-heading">COMPANY</h6>
                <ul class="footer-list">
                    <li><a href="about.html">About</a></li>
                    <li><a href="#">Careers</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="#">Terms</a></li>
                    <li><a href="#">Privacy</a></li>
                </ul>
            </div>
            <div class="col-6 col-md-3 col-lg-2">
                <h6 class="footer-heading">RESOURCES</h6>
                <ul class="footer-list">
                    <li><a href="#">Blog</a></li>
                    <li><a href="#">Documentation</a></li>
                    <li><a href="#">Community</a></li>
                    <li><a href="#">Events</a></li>
                    <li><a href="#">Guides</a></li>
                </ul>
            </div>
            <div class="col-6 col-md-3 col-lg-3">
                <h6 class="footer-heading">GUIDES</h6>
                <ul class="footer-list">
                    <li><a href="#">Digital Marketing Guide</a></li>
                    <li><a href="#">SEO Best Practices</a></li>
                    <li><a href="#">Content Strategy</a></li>
                    <li><a href="#">Analytics & Reporting</a></li>
                    <li><a href="#">Automation Tools</a></li>
                </ul>
            </div>
            <div class="col-12 col-lg-3">
                <h6 class="footer-heading">FOLLOW US</h6>
                <div class="footer-social d-flex gap-3 mt-2">
                    <a href="#" class="footer-social-icon" aria-label="Facebook"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="footer-social-icon" aria-label="Twitter"><i class="bi bi-twitter"></i></a>
                    <a href="#" class="footer-social-icon" aria-label="Instagram"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="footer-social-icon" aria-label="LinkedIn"><i class="bi bi-linkedin"></i></a>
                </div>
            </div>
        </div>
        <hr class="footer-divider my-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="footer-copyright mb-2 mb-md-0">
                &copy; 2025 Cloud Mind Agency. All rights reserved.
            </div>
            <div class="footer-legal">
                <a href="#" class="me-3">Terms of Use</a>
                <a href="#">Privacy Policy</a>
            </div>
        </div>
    </div>
</footer>


<script>
    // Refresh purchase data
    function refreshPurchaseData() {
        console.log('Refreshing purchase data...');
        location.reload();
    }

    // Export purchase data
    function exportPurchaseData() {
        console.log('Exporting purchase data...');
        window.location.href = '/admin/export-purchases';
    }

    // Filter functions
    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for filters
        const packageFilter = document.getElementById('packageFilter');
        const statusFilter = document.getElementById('statusFilter');
        const searchFilter = document.getElementById('searchFilter');

        if (packageFilter) {
            packageFilter.addEventListener('change', function() {
                filterTable();
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                filterTable();
            });
        }

        if (searchFilter) {
            searchFilter.addEventListener('input', function() {
                filterTable();
            });
        }
    });

    function filterTable() {
        const packageFilter = document.getElementById('packageFilter')?.value || 'all';
        const statusFilter = document.getElementById('statusFilter')?.value || 'all';
        const searchFilter = document.getElementById('searchFilter')?.value.toLowerCase() || '';

        const rows = document.querySelectorAll('#purchaseTableBody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) return; // Skip empty state row

            const email = cells[0].textContent.toLowerCase();
            const package = cells[1].textContent.toLowerCase();
            const status = cells[6].textContent.toLowerCase();

            let showRow = true;

            // Package filter
            if (packageFilter !== 'all' && !package.includes(packageFilter)) {
                showRow = false;
            }

            // Status filter
            if (statusFilter !== 'all' && !status.includes(statusFilter)) {
                showRow = false;
            }

            // Search filter
            if (searchFilter && !email.includes(searchFilter)) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });
    }
</script>



<script>
    function markAsRead(messageId) {
        fetch('/admin/contact/mark-read/' + messageId, {
            method: 'POST'
        })
            .then(response => response.text())
            .then(data => {
                if (data === 'success') {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function deleteMessage(messageId) {
        if (confirm('Are you sure you want to delete this message?')) {
            fetch('/admin/contact/delete/' + messageId, {
                method: 'DELETE'
            })
                .then(response => response.text())
                .then(data => {
                    if (data === 'success') {
                        location.reload();
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }
</script>

<script>
    // View subscriber details
    function viewSubscriber(subscriberId) {
        console.log('Viewing subscriber:', subscriberId);

        // CORRECT URL - matches your controller mapping
        fetch('/subscriber/' + subscriberId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(subscriber => {
                if (subscriber) {
                    showSubscriberModal(subscriber);
                } else {
                    alert('Subscriber not found');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading subscriber details: ' + error.message);
            });
    }

    // Show subscriber details modal
    function showSubscriberModal(subscriber) {
        console.log('Subscriber data received:', subscriber);
        console.log('Subscriber status:', subscriber.status); // Debug log

        // Helper functions remain the same...
        const safeValue = (value, defaultValue = 'N/A') => {
            return value && value !== 'null' && value !== null ? value : defaultValue;
        };

        const getFullName = () => {
            const firstName = safeValue(subscriber.firstName, '');
            const lastName = safeValue(subscriber.lastName, '');
            if (firstName === '' && lastName === '') return 'N/A';
            return `${firstName} ${lastName}`.trim();
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        };

        const getPlanPrice = (plan) => {
            switch(plan?.toLowerCase()) {
                case 'enterprise': return '4,999';
                case 'pro': return '2,499';
                case 'starter': return '999';
                default: return '999';
            }
        };

        // FIX: Only check for ACTUALLY cancelled statuses - NOT active users
        const isCancelled = false; // Since deleted users won't be in the database, all shown users are active

        console.log('Is cancelled:', isCancelled); // Debug log
        console.log('Actual status value:', subscriber.status); // Debug log

        const modalHtml = `
        <div class="modal fade" id="subscriberDetailModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-person-circle me-2"></i>Subscriber Details - ID: ${safeValue(subscriber.id)}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Personal Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="bi bi-person me-2"></i>Personal Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless table-sm">
                                            <tr><td class="fw-semibold">Name:</td><td>${subscriber.firstName}</td></tr>
                                            <tr><td class="fw-semibold">Email:</td><td>${safeValue(subscriber.email)}</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light h-100">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Subscription Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-borderless table-sm">
                                            <tr><td class="fw-semibold">Plan:</td><td><span class="badge ${subscriber.plan === 'enterprise' ? 'bg-warning' : (subscriber.plan === 'pro' ? 'bg-success' : 'bg-primary')}">${safeValue(subscriber.plan, 'Starter').toUpperCase()}</span></td></tr>
                                            <tr><td class="fw-semibold">Status:</td><td><span class="badge ${subscriber.status === 'ACTIVE' ? 'bg-success' : 'bg-warning'}">${safeValue(subscriber.status, 'PENDING').toUpperCase()}</span></td></tr>
                                            <tr><td class="fw-semibold">Billing:</td><td>${safeValue(subscriber.billing, 'Monthly')}</td></tr>
                                            <tr><td class="fw-semibold">Payment Method:</td><td>${safeValue(subscriber.paymentMethod, 'Credit Card')}</td></tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revenue Information -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card border-0 bg-warning bg-opacity-10">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>Revenue Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-6">
                                                <div class="fw-bold text-success fs-5">$${getPlanPrice(subscriber.plan)}</div>
                                                <div class="small text-muted">Monthly Value</div>
                                            </div>
                                            <div class="col-6">
                                                <div class="fw-bold text-success fs-5">$${(parseInt(getPlanPrice(subscriber.plan)) * 12).toLocaleString()}</div>
                                                <div class="small text-muted">Annual Value</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x me-1"></i>Close
                        </button>
                        <button type="button" class="btn btn-info" onclick="sendEmailToUser('${safeValue(subscriber.email)}')">
                            <i class="bi bi-envelope me-1"></i>Send Email
                        </button>
                        <button type="button" class="btn btn-warning" onclick="editSubscriber(${safeValue(subscriber.id)})">
                            <i class="bi bi-pencil me-1"></i>Edit Details
                        </button>
                        <button type="button" class="btn btn-danger" onclick="adminCancelSubscription(${safeValue(subscriber.id)})">
                            <i class="bi bi-trash me-1"></i>Delete Subscriber
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Remove existing modal if any
        const existingModal = document.getElementById('subscriberDetailModal');
        if (existingModal) {
            existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('subscriberDetailModal'));
        modal.show();
    }

    // Send email to user function
    function sendEmailToUser(email) {
        const subject = prompt('Enter email subject:', 'Cloud Mind - Important Update');
        if (subject) {
            const message = prompt('Enter your message:', 'Dear valued customer,\n\nWe hope this email finds you well.\n\nBest regards,\nCloud Mind Team');
            if (message) {
                fetch('/admin/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        to: email,
                        subject: subject,
                        message: message
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('✅ Email sent successfully!');
                        } else {
                            alert('❌ Error sending email: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('❌ Error sending email: ' + error.message);
                    });
            }
        }
    }

    // Admin cancel subscription - DELETES the subscriber
    function adminCancelSubscription(subscriberId) {
        if (confirm('⚠️ WARNING: This will PERMANENTLY DELETE this subscriber from the database!\n\nAre you sure you want to proceed?')) {
            const finalConfirm = confirm('🔴 FINAL CONFIRMATION\n\nThis action CANNOT be undone!\n\nClick OK to DELETE the subscriber or Cancel to abort.');

            if (finalConfirm) {
                fetch('/admin/cancel-subscription/' + subscriberId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('✅ Subscriber deleted successfully!');

                            // Close modal if open
                            const modal = document.getElementById('subscriberDetailModal');
                            if (modal) {
                                const modalInstance = bootstrap.Modal.getInstance(modal);
                                if (modalInstance) modalInstance.hide();
                            }

                            // Remove the subscriber row from the table immediately
                            removeSubscriberRow(subscriberId);

                            // Update counters
                            updateSubscriberCount();

                        } else {
                            alert('❌ Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('❌ Error deleting subscriber: ' + error.message);
                    });
            }
        }
    }

    // Helper function to remove subscriber row from table
    function removeSubscriberRow(subscriberId) {
        const rows = document.querySelectorAll('#purchaseTableBody tr');
        rows.forEach(row => {
            const idCell = row.querySelector('td .small.text-muted');
            if (idCell && idCell.textContent.includes('ID: ' + subscriberId)) {
                row.remove();
            }
        });
    }

    // Helper function to update subscriber count
    function updateSubscriberCount() {
        const remainingRows = document.querySelectorAll('#purchaseTableBody tr').length;
        const countElements = document.querySelectorAll('.small.text-muted');
        countElements.forEach(element => {
            if (element.textContent.includes('Showing')) {
                element.innerHTML = `Showing ${remainingRows} of ${remainingRows} subscribers`;
            }
        });
    }


    // Edit subscriber
    function editSubscriber(subscriberId) {
        alert('Edit functionality coming soon!\nSubscriber ID: ' + subscriberId);
        //
    }


    // Cancel subscription from dropdown
    // function cancelSubscription(subscriberId) {
    //     adminCancelSubscription(subscriberId);
    // }
</script>


<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Custom JS -->
<script th:src="@{/js/script.js}"></script>
<script th:src="@{/js/auth.js}"></script>




</body>
</html>